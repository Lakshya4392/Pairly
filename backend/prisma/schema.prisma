// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  email         String    @unique
  displayName   String
  firstName     String?
  lastName      String?
  photoUrl      String?
  phoneNumber   String?
  referralCode  String?   @unique @default(cuid())
  
  // Premium subscription
  isPremium          Boolean   @default(false)
  premiumPlan        String?   // 'monthly' | 'yearly'
  premiumSince       DateTime?
  premiumExpiry      DateTime?
  revenueCatId       String?   // RevenueCat customer ID
  trialEndsAt        DateTime? // 7-day trial tracking
  
  // Daily limits (for free users)
  dailyMomentsCount  Int       @default(0)
  lastMomentDate     DateTime? // Reset counter daily
  
  // Settings
  notificationsEnabled Boolean @default(true)
  soundEnabled         Boolean @default(true)
  vibrationEnabled     Boolean @default(true)
  
  // FCM Push Notifications
  fcmToken      String?   // Firebase Cloud Messaging token
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastActiveAt  DateTime  @default(now())
  
  // Relationships
  pairAsUser1      Pair?            @relation("User1")
  pairAsUser2      Pair?            @relation("User2")
  uploadedMoments  Moment[]         @relation("Uploader")
  sharedNotes      SharedNote[]     @relation("NoteSender")
  timeLockMessages TimeLockMessage[] @relation("MessageSender")
  secretVault      SecretVaultItem[] @relation("VaultOwner")
  dualMomentsAsUser    DualMoment[] @relation("DualMomentUser")
  dualMomentsAsPartner DualMoment[] @relation("DualMomentPartner")
  
  @@index([clerkId])
  @@index([email])
}

model Pair {
  id            String    @id @default(cuid())
  user1Id       String    @unique
  user2Id       String    @unique
  inviteCode    String?   @unique
  codeExpiresAt DateTime?
  pairedAt      DateTime  @default(now())
  
  user1            User              @relation("User1", fields: [user1Id], references: [id])
  user2            User              @relation("User2", fields: [user2Id], references: [id])
  moments          Moment[]
  sharedNotes      SharedNote[]
  timeLockMessages TimeLockMessage[]
  secretVault      SecretVaultItem[]
  
  @@index([inviteCode])
}

model Moment {
  id            String    @id @default(cuid())
  pairId        String
  uploaderId    String
  photoData     Bytes     // BYTEA - stores compressed image
  note          String?   // Optional note/message with moment
  uploadedAt    DateTime  @default(now())
  
  // Scheduled delivery
  isScheduled   Boolean   @default(false)
  scheduledFor  DateTime? // When to show this moment
  deliveredAt   DateTime? // When it was actually delivered
  expiresAt     DateTime? // When to auto-delete (optional)
  
  pair          Pair      @relation(fields: [pairId], references: [id], onDelete: Cascade)
  uploader      User      @relation("Uploader", fields: [uploaderId], references: [id])
  
  @@index([pairId, uploadedAt])
  @@index([isScheduled, scheduledFor])
}

// Pending Moments - Server-side queue for offline users
model PendingMoment {
  id            String    @id @default(cuid())
  userId        String    // Recipient user ID
  momentId      String    // Original moment ID
  photoData     Bytes     // Compressed photo data
  photoUrl      String?   // Optional CDN URL
  senderName    String    // Sender's display name
  note          String?   // Optional note
  createdAt     DateTime  @default(now())
  expiresAt     DateTime  // Auto-delete after 7 days
  
  @@index([userId, createdAt])
  @@index([expiresAt])
}

// NEW PREMIUM FEATURES

// Shared Notes - "Because not every moment needs a photo"
model SharedNote {
  id          String    @id @default(cuid())
  senderId    String
  pairId      String
  content     String    // Max 500 chars
  expiresAt   DateTime? // Auto-delete after 24hrs (optional)
  createdAt   DateTime  @default(now())
  
  sender      User      @relation("NoteSender", fields: [senderId], references: [id])
  pair        Pair      @relation(fields: [pairId], references: [id], onDelete: Cascade)
  
  @@index([pairId, createdAt])
  @@index([expiresAt])
}

// Time-Lock Messages - "Send love to your future"
model TimeLockMessage {
  id            String    @id @default(cuid())
  senderId      String
  pairId        String
  content       String
  photoData     Bytes?    // Optional photo
  unlockDate    DateTime  // When to deliver
  isDelivered   Boolean   @default(false)
  deliveredAt   DateTime?
  createdAt     DateTime  @default(now())
  
  sender        User      @relation("MessageSender", fields: [senderId], references: [id])
  pair          Pair      @relation(fields: [pairId], references: [id], onDelete: Cascade)
  
  @@index([unlockDate, isDelivered])
  @@index([pairId])
}

// Secret Vault - "Some memories are just for you two"
model SecretVaultItem {
  id            String    @id @default(cuid())
  userId        String
  pairId        String
  type          String    // 'photo' | 'video' | 'note'
  encryptedData Bytes     // AES encrypted content
  thumbnail     Bytes?    // Encrypted thumbnail for photos
  title         String?   // Optional title
  createdAt     DateTime  @default(now())
  
  owner         User      @relation("VaultOwner", fields: [userId], references: [id])
  pair          Pair      @relation(fields: [pairId], references: [id], onDelete: Cascade)
  
  @@index([userId, pairId])
  @@index([createdAt])
}

// Dual Camera Moments - "Capture from two worlds, one moment"
model DualMoment {
  id              String    @id @default(cuid())
  userId          String
  partnerId       String
  frontPhotoUrl   String?   // Front camera photo
  backPhotoUrl    String?   // Back camera photo
  note            String?   // Optional note
  status          String    @default("pending") // 'pending' | 'completed'
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  
  user            User      @relation("DualMomentUser", fields: [userId], references: [id])
  partner         User      @relation("DualMomentPartner", fields: [partnerId], references: [id])
  
  @@index([userId, status])
  @@index([partnerId, status])
  @@index([createdAt])
}

// Whitelist System - "Invite-Only Access Control"
model InvitedUser {
  id            String    @id @default(cuid())
  email         String    @unique
  phoneNumber   String?   @unique
  invitedBy     String?   // User ID who sent the invite
  status        String    @default("pending") // 'pending' | 'joined' | 'expired'
  inviteCode    String    @unique @default(cuid())
  invitedAt     DateTime  @default(now())
  joinedAt      DateTime?
  expiresAt     DateTime? // Optional expiry for invite
  
  // Metadata
  source        String?   // 'website', 'app', 'referral', etc.
  name          String?   // Optional name
  
  // Reward tracking
  rewardGranted Boolean   @default(false)
  rewardType    String?   // 'premium_month' | 'premium_3months' | etc.
  
  // App integration (STRICT)
  clerkId       String?   @unique
  referralCount Int       @default(0)
  
  // Premium tracking (STRICT - Time-based premium)
  premiumGrantedAt  DateTime? // When premium was first granted
  premiumExpiresAt  DateTime? // When premium expires
  premiumDays       Int       @default(30) // Total premium days earned
  
  @@index([email])
  @@index([phoneNumber])
  @@index([invitedBy])
  @@index([status])
  @@index([clerkId])
}

// App Configuration - Launch date and waitlist control
model AppConfig {
  id              String   @id @default(cuid())
  launchDate      DateTime // Public launch date
  isWaitlistOnly  Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
